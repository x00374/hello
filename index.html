<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 15px;
            background: #f5f5f5;
            margin: 0;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .gift-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .gift-image {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .gift-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .gift-meta {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .loading, .error {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .sender-info {
            display: flex;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .sender-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <h1>üéÅ –ú–æ–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</h1>
    <div id="gifts-container" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–∞—Ä–∫–æ–≤...</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥–∞—Ä–∫–æ–≤
        async function fetchOwnedGifts() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ –º–µ—Ç–æ–¥ –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ WebApp
                if (!tg.sendData || typeof tg.sendData !== 'function') {
                    throw new Error('–ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                }

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–æ–≤
                const response = await tg.sendData({
                    method: "OwnedGiftUnique",
                    params: {
                        user_id: tg.initDataUnsafe.user?.id
                    }
                });

                if (!response || !response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏');
                }

                return response.result || [];
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–¥–∞—Ä–∫–æ–≤:', error);
                throw error;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–æ–≤
        async function renderGifts() {
            const container = document.getElementById('gifts-container');
            
            try {
                const gifts = await fetchOwnedGifts();
                
                if (gifts.length === 0) {
                    container.innerHTML = '<div class="error">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤</div>';
                    return;
                }

                let html = '<div class="gifts-grid">';
                
                gifts.forEach(gift => {
                    const sendDate = new Date(gift.send_date * 1000).toLocaleDateString();
                    let senderInfo = '';
                    
                    if (gift.sender_user) {
                        senderInfo = `
                            <div class="sender-info">
                                <img src="${gift.sender_user.photo_url || ''}" 
                                     class="sender-avatar" 
                                     onerror="this.style.display='none'">
                                <span>–û—Ç: ${gift.sender_user.first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                            </div>
                        `;
                    }

                    html += `
                        <div class="gift-item">
                            <img src="${gift.gift.image_url}" 
                                 class="gift-image" 
                                 alt="${gift.gift.title}"
                                 onerror="this.src='https://via.placeholder.com/200?text=–ù–µ—Ç+–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'">
                            <div class="gift-title">${gift.gift.title}</div>
                            <div class="gift-meta">
                                <div>–ü–æ–ª—É—á–µ–Ω: ${sendDate}</div>
                                ${gift.is_saved ? '<div>‚≠ê –ù–∞ –ø—Ä–æ—Ñ–∏–ª–µ</div>' : ''}
                                ${gift.can_be_transferred ? 
                                    `<div>–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å (${gift.transfer_star_count || 0} –∑–≤—ë–∑–¥)</div>` : 
                                    ''}
                            </div>
                            ${senderInfo}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `
                    <div class="error">
                        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}<br>
                        <small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</small>
                    </div>
                `;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            if (!tg.initDataUnsafe.user) {
                document.getElementById('gifts-container').innerHTML = `
                    <div class="error">
                        –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram
                    </div>
                `;
                return;
            }
            
            renderGifts();
        });
    </script>
</body>
</html>
